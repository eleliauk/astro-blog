---
title: ReactæŠ€æœ¯æ­ç§˜â€”â€”ç†å¿µ2
published: 2024-10-26T19:01:02.000Z
description: ''
updated: ''
tags: ['React']
draft: false
pin: 0
toc: true
lang: zh
abbrlink: ''
---

# React16 çš„æ–°æ¶æ„
React16 æ¶æ„å¯ä»¥åˆ†ä¸ºä¸‰å±‚ï¼š

- Schedulerï¼ˆè°ƒåº¦å™¨ï¼‰â€”â€” è°ƒåº¦ä»»åŠ¡çš„ä¼˜å…ˆçº§ï¼Œé«˜ä¼˜ä»»åŠ¡ä¼˜å…ˆè¿›å…¥**Reconciler**
- Reconcilerï¼ˆåè°ƒå™¨ï¼‰â€”â€” è´Ÿè´£æ‰¾å‡ºå˜åŒ–çš„ç»„ä»¶
- Rendererï¼ˆæ¸²æŸ“å™¨ï¼‰â€”â€” è´Ÿè´£å°†å˜åŒ–çš„ç»„ä»¶æ¸²æŸ“åˆ°é¡µé¢ä¸Š

å¯ä»¥çœ‹åˆ°ï¼Œç›¸è¾ƒäº React15ï¼ŒReact16 ä¸­æ–°å¢äº†**Schedulerï¼ˆè°ƒåº¦å™¨ï¼‰**ï¼Œè®©æˆ‘ä»¬æ¥äº†è§£ä¸‹ä»–ã€‚

### Schedulerï¼ˆè°ƒåº¦å™¨ï¼‰:haircut:

æ—¢ç„¶æˆ‘ä»¬ä»¥æµè§ˆå™¨æ˜¯å¦æœ‰å‰©ä½™æ—¶é—´ä½œä¸ºä»»åŠ¡ä¸­æ–­çš„æ ‡å‡†ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦ä¸€ç§æœºåˆ¶ï¼Œå½“æµè§ˆå™¨æœ‰å‰©ä½™æ—¶é—´æ—¶é€šçŸ¥æˆ‘ä»¬ã€‚

å…¶å®éƒ¨åˆ†æµè§ˆå™¨å·²ç»å®ç°äº†è¿™ä¸ª APIï¼Œè¿™å°±æ˜¯ [requestIdleCallback](https://developer.mozilla.org/zh-CN/docs/Web/API/Window/requestIdleCallback)ã€‚ä½†æ˜¯ç”±äºä»¥ä¸‹å› ç´ ï¼Œ`React` æ”¾å¼ƒä½¿ç”¨ï¼š

- æµè§ˆå™¨å…¼å®¹æ€§
- è§¦å‘é¢‘ç‡ä¸ç¨³å®šï¼Œå—å¾ˆå¤šå› ç´ å½±å“ã€‚æ¯”å¦‚å½“æˆ‘ä»¬çš„æµè§ˆå™¨åˆ‡æ¢ tab åï¼Œä¹‹å‰ tab æ³¨å†Œçš„ `requestIdleCallback` è§¦å‘çš„é¢‘ç‡ä¼šå˜å¾—å¾ˆä½

åŸºäºä»¥ä¸ŠåŸå› ï¼Œ`React` å®ç°äº†åŠŸèƒ½æ›´å®Œå¤‡çš„ `requestIdleCallback`polyfillï¼Œè¿™å°±æ˜¯**Scheduler**ã€‚é™¤äº†åœ¨ç©ºé—²æ—¶è§¦å‘å›è°ƒçš„åŠŸèƒ½å¤–ï¼Œ**Scheduler**è¿˜æä¾›äº†å¤šç§è°ƒåº¦ä¼˜å…ˆçº§ä¾›ä»»åŠ¡è®¾ç½®ã€‚

> [Scheduler](https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/scheduler/README.md) æ˜¯ç‹¬ç«‹äº `React` çš„åº“

### Reconcilerï¼ˆåè°ƒå™¨ï¼‰

æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨ React15 ä¸­**Reconciler**æ˜¯é€’å½’å¤„ç†è™šæ‹Ÿ DOM çš„ã€‚è®©æˆ‘ä»¬çœ‹çœ‹ [React16 çš„ Reconciler](https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberWorkLoop.new.js#L1673)ã€‚

æˆ‘ä»¬å¯ä»¥çœ‹è§ï¼Œæ›´æ–°å·¥ä½œä»é€’å½’å˜æˆäº†å¯ä»¥ä¸­æ–­çš„å¾ªç¯è¿‡ç¨‹ã€‚æ¯æ¬¡å¾ªç¯éƒ½ä¼šè°ƒç”¨ `shouldYield` åˆ¤æ–­å½“å‰æ˜¯å¦æœ‰å‰©ä½™æ—¶é—´ã€‚
```js
/** @noinline */
function workLoopConcurrent() {
  // Perform work until Scheduler asks us to yield
  while (workInProgress !== null && !shouldYield()) {
    workInProgress = performUnitOfWork(workInProgress);
  }
}
```

é‚£ä¹ˆ React16 æ˜¯å¦‚ä½•è§£å†³ä¸­æ–­æ›´æ–°æ—¶ DOM æ¸²æŸ“ä¸å®Œå…¨çš„é—®é¢˜å‘¢ï¼Ÿ

åœ¨ React16 ä¸­ï¼Œ**Reconciler**ä¸**Renderer**ä¸å†æ˜¯äº¤æ›¿å·¥ä½œã€‚å½“**Scheduler**å°†ä»»åŠ¡äº¤ç»™**Reconciler**åï¼Œ**Reconciler**ä¼šä¸ºå˜åŒ–çš„è™šæ‹Ÿ DOM æ‰“ä¸Šä»£è¡¨å¢/åˆ /æ›´æ–°çš„æ ‡è®°ï¼Œç±»ä¼¼è¿™æ ·ï¼š

```js
export const Placement = /*             */ 0b0000000000010;
export const Update = /*                */ 0b0000000000100;
export const PlacementAndUpdate = /*    */ 0b0000000000110;
export const Deletion = /*              */ 0b0000000001000;
```

> å…¨éƒ¨çš„æ ‡è®°è§ [è¿™é‡Œ](https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactSideEffectTags.js)

æ•´ä¸ª**Scheduler**ä¸**Reconciler**çš„å·¥ä½œéƒ½åœ¨å†…å­˜ä¸­è¿›è¡Œã€‚åªæœ‰å½“æ‰€æœ‰ç»„ä»¶éƒ½å®Œæˆ**Reconciler**çš„å·¥ä½œï¼Œæ‰ä¼šç»Ÿä¸€äº¤ç»™**Renderer**ã€‚

> ä½ å¯ä»¥åœ¨ [è¿™é‡Œ](https://zh-hans.reactjs.org/docs/codebase-overview.html#fiber-reconciler) çœ‹åˆ° `React` å®˜æ–¹å¯¹ React16 æ–°**Reconciler**çš„è§£é‡Š

### Rendererï¼ˆæ¸²æŸ“å™¨ï¼‰

**Renderer**æ ¹æ®**Reconciler**ä¸ºè™šæ‹Ÿ DOM æ‰“çš„æ ‡è®°ï¼ŒåŒæ­¥æ‰§è¡Œå¯¹åº”çš„ DOM æ“ä½œã€‚


`state.count = 1`ï¼Œæ¯æ¬¡ç‚¹å‡»æŒ‰é’® `state.count++`

åˆ—è¡¨ä¸­ 3 ä¸ªå…ƒç´ çš„å€¼åˆ†åˆ«ä¸º 1ï¼Œ2ï¼Œ3 ä¹˜ä»¥ `state.count` çš„ç»“æœ 

åœ¨ React16 æ¶æ„ä¸­æ•´ä¸ªæ›´æ–°æµç¨‹ä¸ºï¼š

<img src="https://react.iamkasong.com/img/process.png" alt="æ›´æ–°æµç¨‹" />

å…¶ä¸­çº¢æ¡†ä¸­çš„æ­¥éª¤éšæ—¶å¯èƒ½ç”±äºä»¥ä¸‹åŸå› è¢«ä¸­æ–­ï¼š

- æœ‰å…¶ä»–æ›´é«˜ä¼˜ä»»åŠ¡éœ€è¦å…ˆæ›´æ–°
- å½“å‰å¸§æ²¡æœ‰å‰©ä½™æ—¶é—´

ç”±äºçº¢æ¡†ä¸­çš„å·¥ä½œéƒ½åœ¨å†…å­˜ä¸­è¿›è¡Œï¼Œä¸ä¼šæ›´æ–°é¡µé¢ä¸Šçš„ DOMï¼Œæ‰€ä»¥å³ä½¿åå¤ä¸­æ–­ï¼Œç”¨æˆ·ä¹Ÿä¸ä¼šçœ‹è§æ›´æ–°ä¸å®Œå…¨çš„ DOM

>æ¥ä¸‹æ¥çœ‹çœ‹ Fiber æ˜¯ä»€ä¹ˆï¼Ÿ
>ä»–å’Œ Reconciler æˆ–è€…è¯´å’Œ React ä¹‹é—´æ˜¯ä»€ä¹ˆå…³ç³»

# fiber æ¶æ„çš„å¿ƒæ™ºæ¨¡å‹

>React æ ¸å¿ƒå›¢é˜Ÿæˆå‘˜ Sebastian MarkbÃ¥geï¼ˆReact Hooks çš„å‘æ˜è€…ï¼‰æ›¾è¯´ï¼šæˆ‘ä»¬åœ¨ React ä¸­åšçš„å°±æ˜¯è·µè¡Œä»£æ•°æ•ˆåº”ï¼ˆAlgebraic Effectsï¼‰ã€‚
>é‚£ä¹ˆï¼Œä»£æ•°æ•ˆåº”æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿä»–å’Œ React æœ‰ä»€ä¹ˆå…³ç³»å‘¢ã€‚

## ä»€ä¹ˆæ˜¯ä»£æ•°æ•ˆåº”

`ä»£æ•°æ•ˆåº” `æ˜¯`å‡½æ•°å¼ç¼–ç¨‹`ä¸­çš„ä¸€ä¸ªæ¦‚å¿µï¼Œç”¨äºå°†`å‰¯ä½œç”¨`ä»`å‡½æ•°` è°ƒç”¨ä¸­åˆ†ç¦»ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬ç”¨ `è™šæ„çš„è¯­æ³•` æ¥è§£é‡Šã€‚

å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªå‡½æ•° `getTotalPicNum`ï¼Œä¼ å…¥ 2 ä¸ª`ç”¨æˆ·åç§°` åï¼Œåˆ†åˆ«æŸ¥æ‰¾è¯¥ç”¨æˆ·åœ¨å¹³å°ä¿å­˜çš„å›¾ç‰‡æ•°é‡ï¼Œæœ€åå°†å›¾ç‰‡æ•°é‡ç›¸åŠ åè¿”å›ã€‚

```js
function getTotalPicNum(user1, user2) {
  const picNum1 = getPicNum(user1);
  const picNum2 = getPicNum(user2);

  return picNum1 + picNum2;
}
```

åœ¨ `getTotalPicNum`ä¸­ï¼Œå…ˆåˆ«å…³æ³¨`getPicNum` çš„å®ç°ï¼Œåªåœ¨ä¹â€œè·å–åˆ°ä¸¤ä¸ªæ•°å­—åå°†ä»–ä»¬ç›¸åŠ çš„ç»“æœè¿”å›â€è¿™ä¸€è¿‡ç¨‹ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬æ¥å®ç° `getPicNum`ã€‚

"ç”¨æˆ·åœ¨å¹³å°ä¿å­˜çš„å›¾ç‰‡æ•°é‡"æ˜¯ä¿å­˜åœ¨æœåŠ¡å™¨ä¸­çš„ã€‚æ‰€ä»¥ï¼Œä¸ºäº†è·å–è¯¥å€¼ï¼Œæˆ‘ä»¬éœ€è¦å‘èµ·å¼‚æ­¥è¯·æ±‚ã€‚

ä¸ºäº†å°½é‡ä¿æŒ `getTotalPicNum` çš„è°ƒç”¨æ–¹å¼ä¸å˜ï¼Œæˆ‘ä»¬é¦–å…ˆæƒ³åˆ°äº†ä½¿ç”¨`async await`ï¼š

```js
async function getTotalPicNum(user1, user2) {
  const picNum1 = await getPicNum(user1);
  const picNum2 = await getPicNum(user2);

  return picNum1 + picNum2;
}
```

ä½†æ˜¯ï¼Œ`async await`æ˜¯æœ‰ `ä¼ æŸ“æ€§` çš„ â€”â€” å½“ä¸€ä¸ªå‡½æ•°å˜ä¸º `async`åï¼Œè¿™æ„å‘³ç€è°ƒç”¨ä»–çš„å‡½æ•°ä¹Ÿéœ€è¦æ˜¯`async`ï¼Œè¿™ç ´åäº†`getTotalPicNum` çš„åŒæ­¥ç‰¹æ€§ã€‚

æœ‰æ²¡æœ‰ä»€ä¹ˆåŠæ³•èƒ½ä¿æŒ `getTotalPicNum` ä¿æŒç°æœ‰è°ƒç”¨æ–¹å¼ä¸å˜çš„æƒ…å†µä¸‹å®ç°å¼‚æ­¥è¯·æ±‚å‘¢ï¼Ÿ

æ²¡æœ‰ã€‚ä¸è¿‡æˆ‘ä»¬å¯ä»¥ `è™šæ„` ä¸€ä¸ªã€‚

æˆ‘ä»¬è™šæ„ä¸€ä¸ªç±»ä¼¼ `try...catch` çš„è¯­æ³• â€”â€” `try...handle` ä¸ä¸¤ä¸ªæ“ä½œç¬¦ `perform`ã€`resume`ã€‚

```js
function getPicNum(name) {
  const picNum = perform name;
  return picNum;
}

try {
  getTotalPicNum('shanyujia', 'react');
} handle (who) {
  switch (who) {
    case 'shanyujia':
      resume with 230;
    case 'react':
      resume with 122;
    default:
      resume with 0;
  }
}
```

å½“æ‰§è¡Œåˆ° `getTotalPicNum`å†…éƒ¨çš„`getPicNum` æ–¹æ³•æ—¶ï¼Œä¼šæ‰§è¡Œ`perform name`ã€‚

æ­¤æ—¶å‡½æ•°è°ƒç”¨æ ˆä¼šä» `getPicNum`æ–¹æ³•å†…è·³å‡ºï¼Œè¢«æœ€è¿‘ä¸€ä¸ª`try...handle` æ•è·ã€‚ç±»ä¼¼`throw Error`åè¢«æœ€è¿‘ä¸€ä¸ª `try...catch` æ•è·ã€‚

ç±»ä¼¼`throw Error`å `Error`ä¼šä½œä¸º`catch` çš„å‚æ•°ï¼Œ`perform name`å `name`ä¼šä½œä¸º`handle` çš„å‚æ•°ã€‚

ä¸ `try...catch`æœ€å¤§çš„ä¸åŒåœ¨äºï¼šå½“`Error`è¢«`catch`æ•è·åï¼Œä¹‹å‰çš„è°ƒç”¨æ ˆå°±é”€æ¯äº†ã€‚è€Œ`handle`æ‰§è¡Œ`resume`åä¼šå›åˆ°ä¹‹å‰`perform` çš„è°ƒç”¨æ ˆã€‚

å¯¹äº`case 'kaSong'`ï¼Œæ‰§è¡Œå®Œ`resume with 230;`åè°ƒç”¨æ ˆä¼šå›åˆ° `getPicNum`ï¼Œæ­¤æ—¶`picNum === 230`

>æ³¨æ„:warning:
>
>å†æ¬¡ç”³æ˜ï¼Œ`try...handle`çš„è¯­æ³•æ˜¯è™šæ„çš„ï¼Œçœ‹çœ‹ `ä»£æ•°æ•ˆåº”` çš„æ€æƒ³ã€‚

æ€»ç»“ä¸€ä¸‹ï¼š`ä»£æ•°æ•ˆåº” `èƒ½å¤Ÿå°†`å‰¯ä½œç”¨`ï¼ˆä¾‹å­ä¸­ä¸º` è¯·æ±‚å›¾ç‰‡æ•°é‡`ï¼‰ä»å‡½æ•°é€»è¾‘ä¸­åˆ†ç¦»ï¼Œä½¿å‡½æ•°å…³æ³¨ç‚¹ä¿æŒçº¯ç²¹ã€‚

å¹¶ä¸”ï¼Œä»ä¾‹å­ä¸­å¯ä»¥çœ‹å‡ºï¼Œ`perform resume`ä¸éœ€è¦åŒºåˆ†åŒæ­¥å¼‚æ­¥ã€‚

## ä»£æ•°æ•ˆåº”åœ¨ React ä¸­çš„åº”ç”¨

é‚£ä¹ˆ `ä»£æ•°æ•ˆåº”`ä¸`React` æœ‰ä»€ä¹ˆå…³ç³»å‘¢ï¼Ÿæœ€æ˜æ˜¾çš„ä¾‹å­å°±æ˜¯`Hooks`ã€‚

å¯¹äºç±»ä¼¼ `useState`ã€`useReducer`ã€`useRef`è¿™æ ·çš„`Hook`ï¼Œæˆ‘ä»¬ä¸éœ€è¦å…³æ³¨`FunctionComponent`çš„`state`åœ¨`Hook`ä¸­æ˜¯å¦‚ä½•ä¿å­˜çš„ï¼Œ`React` ä¼šä¸ºæˆ‘ä»¬å¤„ç†ã€‚

æˆ‘ä»¬åªéœ€è¦å‡è®¾ `useState` è¿”å›çš„æ˜¯æˆ‘ä»¬æƒ³è¦çš„`state`ï¼Œå¹¶ç¼–å†™ä¸šåŠ¡é€»è¾‘å°±è¡Œã€‚

```js
function App() {
  const [num, updateNum] = useState(0);
  
  return (
    <button onClick={() => updateNum(num => num + 1)}>{num}</button>  
  )
}
```

## ä»£æ•°æ•ˆåº”ä¸ Generator

ä» `React15`åˆ°`React16`ï¼Œåè°ƒå™¨ï¼ˆ`Reconciler`ï¼‰é‡æ„çš„ä¸€å¤§ç›®çš„æ˜¯ï¼šå°†è€çš„`åŒæ­¥æ›´æ–°`çš„æ¶æ„å˜ä¸º` å¼‚æ­¥å¯ä¸­æ–­æ›´æ–°`ã€‚

`å¼‚æ­¥å¯ä¸­æ–­æ›´æ–° `å¯ä»¥ç†è§£ä¸ºï¼š`æ›´æ–°` åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å¯èƒ½ä¼šè¢«æ‰“æ–­ï¼ˆæµè§ˆå™¨æ—¶é—´åˆ†ç‰‡ç”¨å°½æˆ–æœ‰æ›´é«˜ä¼˜ä»»åŠ¡æ’é˜Ÿï¼‰ï¼Œå½“å¯ä»¥ç»§ç»­æ‰§è¡Œæ—¶æ¢å¤ä¹‹å‰æ‰§è¡Œçš„ä¸­é—´çŠ¶æ€ã€‚

è¿™å°±æ˜¯ `ä»£æ•°æ•ˆåº”`ä¸­`try...handle` çš„ä½œç”¨ã€‚

å…¶å®ï¼Œæµè§ˆå™¨åŸç”Ÿå°±æ”¯æŒç±»ä¼¼çš„å®ç°ï¼Œè¿™å°±æ˜¯ `Generator`ã€‚

ä½†æ˜¯ `Generator`çš„ä¸€äº›ç¼ºé™·ä½¿`React` å›¢é˜Ÿæ”¾å¼ƒäº†ä»–ï¼š

- ç±»ä¼¼ `async`ï¼Œ`Generator`ä¹Ÿæ˜¯`ä¼ æŸ“æ€§`çš„ï¼Œä½¿ç”¨äº†`Generator` åˆ™ä¸Šä¸‹æ–‡çš„å…¶ä»–å‡½æ•°ä¹Ÿéœ€è¦ä½œå‡ºæ”¹å˜ã€‚è¿™æ ·å¿ƒæ™ºè´Ÿæ‹…æ¯”è¾ƒé‡ã€‚
- `Generator`æ‰§è¡Œçš„ `ä¸­é—´çŠ¶æ€` æ˜¯ä¸Šä¸‹æ–‡å…³è”çš„ã€‚

çœ‹çœ‹ä¸‹é¢çš„ğŸŒ°

```js
function* doWork(A, B, C) {
  var x = doExpensiveWorkA(A);
  yield;
  var y = x + doExpensiveWorkB(B);
  yield;
  var z = y + doExpensiveWorkC(C);
  return z;
}
```

æ¯å½“æµè§ˆå™¨æœ‰ç©ºé—²æ—¶é—´éƒ½ä¼šä¾æ¬¡æ‰§è¡Œå…¶ä¸­ä¸€ä¸ª `doExpensiveWork`ï¼Œå½“æ—¶é—´ç”¨å°½åˆ™ä¼šä¸­æ–­ï¼Œå½“å†æ¬¡æ¢å¤æ—¶ä¼šä»ä¸­æ–­ä½ç½®ç»§ç»­æ‰§è¡Œã€‚

åªè€ƒè™‘â€œå•ä¸€ä¼˜å…ˆçº§ä»»åŠ¡çš„ä¸­æ–­ä¸ç»§ç»­â€æƒ…å†µä¸‹ `Generator`å¯ä»¥å¾ˆå¥½çš„å®ç°` å¼‚æ­¥å¯ä¸­æ–­æ›´æ–°`ã€‚

ä½†æ˜¯å½“æˆ‘ä»¬è€ƒè™‘â€œé«˜ä¼˜å…ˆçº§ä»»åŠ¡æ’é˜Ÿâ€çš„æƒ…å†µï¼Œå¦‚æœæ­¤æ—¶å·²ç»å®Œæˆ `doExpensiveWorkA`ä¸`doExpensiveWorkB`è®¡ç®—å‡º`x` ä¸`y`ã€‚

æ­¤æ—¶ `B`ç»„ä»¶æ¥æ”¶åˆ°ä¸€ä¸ª`é«˜ä¼˜æ›´æ–°`ï¼Œç”±äº`Generator`æ‰§è¡Œçš„`ä¸­é—´çŠ¶æ€`æ˜¯ä¸Šä¸‹æ–‡å…³è”çš„ï¼Œæ‰€ä»¥è®¡ç®—`y` æ—¶æ— æ³•å¤ç”¨ä¹‹å‰å·²ç»è®¡ç®—å‡ºçš„`x`ï¼Œéœ€è¦é‡æ–°è®¡ç®—ã€‚

å¦‚æœé€šè¿‡ `å…¨å±€å˜é‡`ä¿å­˜ä¹‹å‰æ‰§è¡Œçš„` ä¸­é—´çŠ¶æ€`ï¼Œåˆä¼šå¼•å…¥æ–°çš„å¤æ‚åº¦ã€‚

åŸºäºè¿™äº›åŸå› ï¼Œ`React`æ²¡æœ‰é‡‡ç”¨ `Generator`å®ç°` åè°ƒå™¨`ã€‚

## ä»£æ•°æ•ˆåº”ä¸ Fiber

`Fiber`å¹¶ä¸æ˜¯è®¡ç®—æœºæœ¯è¯­ä¸­çš„æ–°åè¯ï¼Œä»–çš„ä¸­æ–‡ç¿»è¯‘å«åš ` çº¤ç¨‹`ï¼Œä¸è¿›ç¨‹ï¼ˆProcessï¼‰ã€çº¿ç¨‹ï¼ˆThreadï¼‰ã€åç¨‹ï¼ˆCoroutineï¼‰åŒä¸ºç¨‹åºæ‰§è¡Œè¿‡ç¨‹ã€‚

åœ¨å¾ˆå¤šæ–‡ç« ä¸­å°† `çº¤ç¨‹`ç†è§£ä¸º`åç¨‹`çš„ä¸€ç§å®ç°ã€‚åœ¨`JS`ä¸­ï¼Œ`åç¨‹` çš„å®ç°ä¾¿æ˜¯`Generator`ã€‚

æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥å°† `çº¤ç¨‹`(Fiber)ã€`åç¨‹`(Generator) ç†è§£ä¸º`ä»£æ•°æ•ˆåº”`æ€æƒ³åœ¨`JS` ä¸­çš„ä½“ç°ã€‚

`React Fiber`å¯ä»¥ç†è§£ä¸ºï¼š

`React`å†…éƒ¨å®ç°çš„ä¸€å¥—çŠ¶æ€æ›´æ–°æœºåˆ¶ã€‚æ”¯æŒä»»åŠ¡ä¸åŒ `ä¼˜å…ˆçº§`ï¼Œå¯ä¸­æ–­ä¸æ¢å¤ï¼Œå¹¶ä¸”æ¢å¤åå¯ä»¥å¤ç”¨ä¹‹å‰çš„` ä¸­é—´çŠ¶æ€`ã€‚

å…¶ä¸­æ¯ä¸ªä»»åŠ¡æ›´æ–°å•å…ƒä¸º`React Element`å¯¹åº”çš„ `Fiber èŠ‚ç‚¹`ã€‚

æ¥ä¸‹æ¥ï¼Œåº·åº· `Fiber æ¶æ„` çš„å®ç°

## Fiber çš„èµ·æº

> æœ€æ—©çš„ `Fiber` å®˜æ–¹è§£é‡Šæ¥æºäº [2016 å¹´ React å›¢é˜Ÿæˆå‘˜ Acdlite çš„ä¸€ç¯‡ä»‹ç»](https://github.com/acdlite/react-fiber-architecture)ã€‚

åœ¨ `React15`åŠä»¥å‰ï¼Œ`Reconciler` é‡‡ç”¨é€’å½’çš„æ–¹å¼åˆ›å»ºè™šæ‹Ÿ DOMï¼Œé€’å½’è¿‡ç¨‹æ˜¯ä¸èƒ½ä¸­æ–­çš„ã€‚å¦‚æœç»„ä»¶æ ‘çš„å±‚çº§å¾ˆæ·±ï¼Œé€’å½’ä¼šå ç”¨çº¿ç¨‹å¾ˆå¤šæ—¶é—´ï¼Œé€ æˆå¡é¡¿ã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œ`React16`å°†**é€’å½’çš„æ— æ³•ä¸­æ–­çš„æ›´æ–°**é‡æ„ä¸º**å¼‚æ­¥çš„å¯ä¸­æ–­æ›´æ–°**ï¼Œç”±äºæ›¾ç»ç”¨äºé€’å½’çš„**è™šæ‹Ÿ DOM**æ•°æ®ç»“æ„å·²ç»æ— æ³•æ»¡è¶³éœ€è¦ã€‚äºæ˜¯ï¼Œå…¨æ–°çš„ `Fiber` æ¶æ„åº”è¿è€Œç”Ÿã€‚

## Fiber çš„å«ä¹‰

`Fiber` åŒ…å«ä¸‰å±‚å«ä¹‰ï¼š

1. ä½œä¸ºæ¶æ„æ¥è¯´ï¼Œä¹‹å‰ `React15`çš„`Reconciler` é‡‡ç”¨é€’å½’çš„æ–¹å¼æ‰§è¡Œï¼Œæ•°æ®ä¿å­˜åœ¨é€’å½’è°ƒç”¨æ ˆä¸­ï¼Œæ‰€ä»¥è¢«ç§°ä¸º`stack Reconciler`ã€‚`React16`çš„ `Reconciler`åŸºäº`Fiber èŠ‚ç‚¹` å®ç°ï¼Œè¢«ç§°ä¸º`Fiber Reconciler`ã€‚
2. ä½œä¸ºé™æ€çš„æ•°æ®ç»“æ„æ¥è¯´ï¼Œæ¯ä¸ª `Fiber èŠ‚ç‚¹` å¯¹åº”ä¸€ä¸ª`React element`ï¼Œä¿å­˜äº†è¯¥ç»„ä»¶çš„ç±»å‹ï¼ˆå‡½æ•°ç»„ä»¶/ç±»ç»„ä»¶/åŸç”Ÿç»„ä»¶...ï¼‰ã€å¯¹åº”çš„ DOM èŠ‚ç‚¹ç­‰ä¿¡æ¯ã€‚
3. ä½œä¸ºåŠ¨æ€çš„å·¥ä½œå•å…ƒæ¥è¯´ï¼Œæ¯ä¸ª `Fiber èŠ‚ç‚¹` ä¿å­˜äº†æœ¬æ¬¡æ›´æ–°ä¸­è¯¥ç»„ä»¶æ”¹å˜çš„çŠ¶æ€ã€è¦æ‰§è¡Œçš„å·¥ä½œï¼ˆéœ€è¦è¢«åˆ é™¤/è¢«æ’å…¥é¡µé¢ä¸­/è¢«æ›´æ–°...ï¼‰ã€‚

## Fiber çš„ç»“æ„

```js
function FiberNode(
  tag: WorkTag,
  pendingProps: mixed,
  key: null | string,
  mode: TypeOfMode,
) {
  // ä½œä¸ºé™æ€æ•°æ®ç»“æ„çš„å±æ€§
  this.tag = tag;
  this.key = key;
  this.elementType = null;
  this.type = null;
  this.stateNode = null;

  // ç”¨äºè¿æ¥å…¶ä»– Fiber èŠ‚ç‚¹å½¢æˆ Fiber æ ‘
  this.return = null;
  this.child = null;
  this.sibling = null;
  this.index = 0;

  this.ref = null;

  // ä½œä¸ºåŠ¨æ€çš„å·¥ä½œå•å…ƒçš„å±æ€§
  this.pendingProps = pendingProps;
  this.memoizedProps = null;
  this.updateQueue = null;
  this.memoizedState = null;
  this.dependencies = null;

  this.mode = mode;

  this.effectTag = NoEffect;
  this.nextEffect = null;

  this.firstEffect = null;
  this.lastEffect = null;

  // è°ƒåº¦ä¼˜å…ˆçº§ç›¸å…³
  this.lanes = NoLanes;
  this.childLanes = NoLanes;

  // æŒ‡å‘è¯¥ fiber åœ¨å¦ä¸€æ¬¡æ›´æ–°æ—¶å¯¹åº”çš„ fiber
  this.alternate = null;
}
```

### ä½œä¸ºæ¶æ„æ¥è¯´

æ¯ä¸ª Fiber èŠ‚ç‚¹æœ‰ä¸ªå¯¹åº”çš„`React element`ï¼Œå¤šä¸ª `Fiber èŠ‚ç‚¹` æ˜¯æ€ä¹ˆè¿æ¥å½¢æˆæ ‘å‘¢ï¼Ÿç”¨ä¸‹é¢ä¸‰ä¸ªå±æ€§ï¼š

```js
// æŒ‡å‘çˆ¶çº§ Fiber èŠ‚ç‚¹
this.return = null;
// æŒ‡å‘å­ Fiber èŠ‚ç‚¹
this.child = null;
// æŒ‡å‘å³è¾¹ç¬¬ä¸€ä¸ªå…„å¼Ÿ Fiber èŠ‚ç‚¹
this.sibling = null;
```

ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚ä¸‹çš„ç»„ä»¶ç»“æ„ï¼š

```js
function App() {
  return (
    <div>
      i am
      <span>KaSong</span>
    </div>
  )
}
```

<img src="https://react.iamkasong.com/img/fiber.png" alt="" />

> è¿™é‡Œéœ€è¦æä¸€ä¸‹ï¼Œä¸ºä»€ä¹ˆçˆ¶çº§æŒ‡é’ˆå«åš `return`è€Œä¸æ˜¯`parent`æˆ–è€…`father`å‘¢ï¼Ÿå› ä¸ºä½œä¸ºä¸€ä¸ªå·¥ä½œå•å…ƒï¼Œ`return`æŒ‡èŠ‚ç‚¹æ‰§è¡Œå®Œ`completeWork`ï¼ˆæœ¬ç« åé¢ä¼šä»‹ç»ï¼‰åä¼šè¿”å›çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚å­`Fiber èŠ‚ç‚¹`åŠå…¶å…„å¼ŸèŠ‚ç‚¹å®Œæˆå·¥ä½œåä¼šè¿”å›å…¶çˆ¶çº§èŠ‚ç‚¹ï¼Œæ‰€ä»¥ç”¨`return` æŒ‡ä»£çˆ¶çº§èŠ‚ç‚¹ã€‚

### ä½œä¸ºé™æ€çš„æ•°æ®ç»“æ„

ä½œä¸ºä¸€ç§é™æ€çš„æ•°æ®ç»“æ„ï¼Œä¿å­˜äº†ç»„ä»¶ç›¸å…³çš„ä¿¡æ¯ï¼š

```js
// Fiber å¯¹åº”ç»„ä»¶çš„ç±»å‹ Function/Class/Host...
this.tag = tag;
// key å±æ€§
this.key = key;
// å¤§éƒ¨åˆ†æƒ…å†µåŒ typeï¼ŒæŸäº›æƒ…å†µä¸åŒï¼Œæ¯”å¦‚ FunctionComponent ä½¿ç”¨ React.memo åŒ…è£¹
this.elementType = null;
// å¯¹äº FunctionComponentï¼ŒæŒ‡å‡½æ•°æœ¬èº«ï¼Œå¯¹äº ClassComponentï¼ŒæŒ‡ classï¼Œå¯¹äº HostComponentï¼ŒæŒ‡ DOM èŠ‚ç‚¹ tagName
this.type = null;
// Fiber å¯¹åº”çš„çœŸå® DOM èŠ‚ç‚¹
this.stateNode = null;
```

### ä½œä¸ºåŠ¨æ€çš„å·¥ä½œå•å…ƒ

ä½œä¸ºåŠ¨æ€çš„å·¥ä½œå•å…ƒï¼Œ`Fiber` ä¸­å¦‚ä¸‹å‚æ•°ä¿å­˜äº†æœ¬æ¬¡æ›´æ–°ç›¸å…³çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬ä¼šåœ¨åç»­çš„æ›´æ–°æµç¨‹ä¸­ä½¿ç”¨åˆ°å…·ä½“å±æ€§æ—¶å†è¯¦ç»†ä»‹ç»

```js
// ä¿å­˜æœ¬æ¬¡æ›´æ–°é€ æˆçš„çŠ¶æ€æ”¹å˜ç›¸å…³ä¿¡æ¯
this.pendingProps = pendingProps;
this.memoizedProps = null;
this.updateQueue = null;
this.memoizedState = null;
this.dependencies = null;

this.mode = mode;

// ä¿å­˜æœ¬æ¬¡æ›´æ–°ä¼šé€ æˆçš„ DOM æ“ä½œ
this.effectTag = NoEffect;
this.nextEffect = null;

this.firstEffect = null;
this.lastEffect = null;
```

å¦‚ä¸‹ä¸¤ä¸ªå­—æ®µä¿å­˜è°ƒåº¦ä¼˜å…ˆçº§ç›¸å…³çš„ä¿¡æ¯ï¼Œä¼šåœ¨è®²è§£ `Scheduler` æ—¶ä»‹ç»ã€‚

```js
// è°ƒåº¦ä¼˜å…ˆçº§ç›¸å…³
this.lanes = NoLanes;
this.childLanes = NoLanes;
```

æ³¨æ„

åœ¨ 2020 å¹´ 5 æœˆï¼Œè°ƒåº¦ä¼˜å…ˆçº§ç­–ç•¥ç»å†äº†æ¯”è¾ƒå¤§çš„é‡æ„ã€‚ä»¥ `expirationTime`å±æ€§ä¸ºä»£è¡¨çš„ä¼˜å…ˆçº§æ¨¡å‹è¢«`lane` å–ä»£ã€‚å¯ä»¥çœ‹çœ‹ [è¿™ä¸ª PR](https://github.com/facebook/react/pull/18796)

é‚£ä¹ˆ `Fiber æ ‘`å’Œé¡µé¢å‘ˆç°çš„`DOM æ ‘`æœ‰ä»€ä¹ˆå…³ç³»ï¼Œ`React`åˆæ˜¯å¦‚ä½•æ›´æ–°`DOM` çš„å‘¢ï¼Ÿ

ä¸”å¬ä¸‹å›åˆ†è§£ï¼ ï¼ˆå†™ä¸åŠ¨äº†ï¼‰ğŸ¥±

## å¤æ´»ï¼è¡¥ä¸Š
æˆ‘ä»¬ç°åœ¨çŸ¥é“äº† Fiber æ˜¯ä»€ä¹ˆï¼ŒçŸ¥é“ Fiber èŠ‚ç‚¹å¯ä»¥ä¿å­˜å¯¹åº”çš„ DOM èŠ‚ç‚¹ã€‚
ç›¸åº”çš„ï¼ŒFiber èŠ‚ç‚¹æ„æˆçš„ Fiber æ ‘å°±å¯¹åº” DOM æ ‘ã€‚
é‚£ä¹ˆå¦‚ä½•æ›´æ–° DOM å‘¢ï¼Ÿè¿™éœ€è¦ç”¨åˆ°è¢«ç§°ä¸ºâ€œåŒç¼“å­˜â€çš„æŠ€æœ¯ã€‚


